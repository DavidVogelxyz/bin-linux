#!/usr/bin/env bash

# Name:     dev-tmux
# Author:   David Vogel <david@davidvogel.xyz>
# Date:     2025 Sep 7, Sun
# License:  GPL v3.0
# Desc:     `dev-tmux` allows a user to start `tmux` with a "session loadout".

SCRIPT_NAME="dev-tmux"

# `SESH` is the list of sessions to open
# The format is `"<NAME>:<PATH>"`
# Note that the list's order is preserved
SESH=(
    "homedir:${HOME}"
    "${PREF_SESH}:${HOME}"
)

# `PREF_SESH` will be the open session when `dev-tmux` returns
PREF_SESH="scratch"

# CONFIG FILE:
# The script has defaults that will work "out-of-the-box"
# To change settings, use the config file instead of editing the script
# The config file should be named:
#       dev-tmux.conf
# The config file should be located at any of the following paths:
#       ${HOME}/.config/bin-linux/dev-tmux/dev-tmux.conf
#       ${HOME}/.config/bin-linux/dev-tmux.conf
#       ${HOME}/.config/dev-tmux/dev-tmux.conf
#       ${HOME}/.config/dev-tmux.conf
#       ${HOME}/dev-tmux.conf
source_conf() {
    CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"

    if [[ -f "${CONFIG_DIR}/bin-linux/${SCRIPT_NAME}/${SCRIPT_NAME}.conf" ]]; then
        CONFIG_FILE="${CONFIG_DIR}/bin-linux/${SCRIPT_NAME}/${SCRIPT_NAME}.conf"
    elif [[ -f "${CONFIG_DIR}/bin-linux/${SCRIPT_NAME}.conf" ]]; then
        CONFIG_FILE="${CONFIG_DIR}/bin-linux/${SCRIPT_NAME}.conf"
    elif [[ -f "${CONFIG_DIR}/${SCRIPT_NAME}/${SCRIPT_NAME}.conf" ]]; then
        CONFIG_FILE="${CONFIG_DIR}/${SCRIPT_NAME}/${SCRIPT_NAME}.conf"
    elif [[ -f "${CONFIG_DIR}/${SCRIPT_NAME}.conf" ]]; then
        CONFIG_FILE="${CONFIG_DIR}/${SCRIPT_NAME}.conf"
    elif [[ -f "${HOME}/${SCRIPT_NAME}.conf" ]]; then
        CONFIG_FILE="${HOME}/${SCRIPT_NAME}.conf"
    else
        return 0
    fi

    source "$CONFIG_FILE"
}

# NOTE: the `sleep 1` is crucial for preserving the order of the sessions
dt_loop() {
    local total=${#SESH[@]}
    local n=0

    for s in "${SESH[@]}"; do
        local s_name="${s%%:*}"
        local s_path="${s##*:}"
        ((++n))

        echo "[INFO]: Creating session ${n}/${total} - \"$s_name\"."
        tmux new-session -ds "$s_name" -c $s_path
        sleep 1
    done
}

main() {
    source_conf
    dt_loop
    echo "[INFO]: Attaching to \"${PREF_SESH}\"."
    tmux a -t ${PREF_SESH}
}

main
